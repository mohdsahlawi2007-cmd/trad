from telegram.ext import Updater, CommandHandler
from config import TELEGRAM_BOT_TOKEN
from binance_client import get_price

# ØªØ®Ø²ÙŠÙ† Ø¨Ø³ÙŠØ· Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© (ÙŠØ®ØªÙÙŠ Ù„Ùˆ Ø§Ù„Ø¨ÙˆØª Ø·ÙÙ‰)
alerts = {}  # user_id -> {"symbol": "BTCUSDT", "target": 70000}

def start(update, context):
    text = (
        "Ø£Ù‡Ù„Ø§Ù‹ ğŸ‘‹\n"
        "Ø£Ù†Ø§ Ø¨ÙˆØª ØªØ¯Ø§ÙˆÙ„ Ø¨Ø³ÙŠØ· Ù„Ù„Ù…Ø¨ØªØ¯Ø¦ÙŠÙ† ÙˆØ±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„ØµØºÙŠØ±.\n\n"
        "Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:\n"
        "/price Ø±Ù…Ø²_Ø§Ù„Ø¹Ù…Ù„Ø© - Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ\n"
        "Ù…Ø«Ø§Ù„: /price BTCUSDT\n\n"
        "/alert Ø±Ù…Ø²_Ø§Ù„Ø¹Ù…Ù„Ø© Ø³Ø¹Ø±_Ø§Ù„Ù‡Ø¯Ù - ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø¹Ø±\n"
        "Ù…Ø«Ø§Ù„: /alert BTCUSDT 70000\n\n"
        "âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¨ÙˆØª Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙˆØ§Ù„ØªØ¹Ù„Ù‘Ù… ÙÙ‚Ø·ØŒ Ù…Ùˆ Ù„Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„Ù…Ø¶Ù…ÙˆÙ†Ø©."
    )
    update.message.reply_text(text)

def price_command(update, context):
    try:
        if not context.args:
            update.message.reply_text("Ø§ÙƒØªØ¨ Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø±.\nÙ…Ø«Ø§Ù„:\n/price BTCUSDT")
            return

        symbol = context.args[0].upper()
        price = get_price(symbol)
        update.message.reply_text(f"Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù€ {symbol}: {price}")
    except Exception:
        update.message.reply_text("Ù…Ø§ Ù‚Ø¯Ø±Øª Ø£Ø¬ÙŠØ¨ Ø§Ù„Ø³Ø¹Ø±. ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø© Ù…Ø«Ù„: BTCUSDT, ETHUSDT")

def alert_command(update, context):
    try:
        if len(context.args) < 2:
            update.message.reply_text(
                "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ù…Ø±:\n"
                "/alert Ø±Ù…Ø²_Ø§Ù„Ø¹Ù…Ù„Ø© Ø³Ø¹Ø±_Ø§Ù„Ù‡Ø¯Ù\n"
                "Ù…Ø«Ø§Ù„:\n"
                "/alert BTCUSDT 70000"
            )
            return

        symbol = context.args[0].upper()
        target = float(context.args[1])
        user_id = update.message.from_user.id

        alerts[user_id] = {
            "symbol": symbol,
            "target": target
        }

        update.message.reply_text(
            f"âœ… ØªÙ… Ø¶Ø¨Ø· ØªÙ†Ø¨ÙŠÙ‡ Ù„Ùƒ:\n"
            f"- Ø§Ù„Ø¹Ù…Ù„Ø©: {symbol}\n"
            f"- Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: {target}"
        )
    except Exception:
        update.message.reply_text("ØªØ£ÙƒØ¯ Ù…Ù† ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø³Ø¹Ø± ÙƒØ±Ù‚Ù… ØµØ­ÙŠØ­.\nÙ…Ø«Ø§Ù„:\n/alert BTCUSDT 70000")

def myalert_command(update, context):
    user_id = update.message.from_user.id
    if user_id not in alerts:
        update.message.reply_text("Ù…Ø§ Ø¹Ù†Ø¯Ùƒ Ø£ÙŠ ØªÙ†Ø¨ÙŠÙ‡ Ø­Ø§Ù„ÙŠØ§Ù‹.")
        return

    data = alerts[user_id]
    update.message.reply_text(
        f"ØªÙ†Ø¨ÙŠÙ‡Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ:\n"
        f"- Ø§Ù„Ø¹Ù…Ù„Ø©: {data['symbol']}\n"
        f"- Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù: {data['target']}"
    )

def clearalert_command(update, context):
    user_id = update.message.from_user.id
    if user_id in alerts:
        del alerts[user_id]
        update.message.reply_text("âœ… ØªÙ… Ø­Ø°Ù ØªÙ†Ø¨ÙŠÙ‡Ùƒ.")
    else:
        update.message.reply_text("Ù…Ø§ Ø¹Ù†Ø¯Ùƒ Ø£ÙŠ ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø³Ø¬Ù„.")

def check_alerts(context):
    """
    Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ´ØªØºÙ„ ÙƒÙ„ ÙØªØ±Ø© (Ù…Ø«Ù„Ø§Ù‹ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©) ÙˆØªØ´ÙŠÙƒ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
    """
    for user_id, data in list(alerts.items()):
        symbol = data["symbol"]
        target = data["target"]

        try:
            current_price = get_price(symbol)
        except Exception:
            continue

        # Ù‡Ù†Ø§ Ù…Ù† Ø¨Ø§Ø¨ Ø§Ù„Ø¨Ø³Ø§Ø·Ø©: Ù†Ù†Ø¨Ù‡ Ø¥Ø°Ø§ ÙˆØµÙ„ Ø£Ùˆ ØªØ¹Ø¯Ù‰ Ø§Ù„Ù‡Ø¯Ù (ÙÙˆÙ‚ Ø£Ùˆ ØªØ­Øª)
        if current_price >= target:
            context.bot.send_message(
                chat_id=user_id,
                text=(
                    f"ğŸš€ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø³Ø¹Ø±!\n"
                    f"{symbol} ÙˆØµÙ„ Ø§Ù„Ø³Ø¹Ø± {current_price}\n"
                    f"(Ù‡Ø¯ÙÙƒ ÙƒØ§Ù†: {target})"
                )
            )
            # Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù†Ø­Ø°Ù Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø­ØªÙ‰ Ù…Ø§ ÙŠØªÙƒØ±Ø±
            del alerts[user_id]

def main():
    updater = Updater(TELEGRAM_BOT_TOKEN, use_context=True)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CommandHandler("price", price_command))
    dp.add_handler(CommandHandler("alert", alert_command))
    dp.add_handler(CommandHandler("myalert", myalert_command))
    dp.add_handler(CommandHandler("clearalert", clearalert_command))

    # Job Queue Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ
    job_queue = updater.job_queue
    job_queue.run_repeating(check_alerts, interval=30, first=10)

    updater.start_polling()
    updater.idle()

if name == "__main__":
    main()
